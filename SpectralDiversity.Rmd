---
title: "Spectral Diversity"
author: "Eric Jensen"
date: "April 21, 2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
library(vegan)
library(sf)
library(plyr)
```


)### Import spectral diversity tables
**Input datasets:**  
- Normalized histograms  
- Unsupervised classification histograms  
- Tasseled cap histograms  
- Index standard deviations  

**Normalized histograms**
```{r}
# Read in normalized histograms
norm_hists_all <- read_csv('data/DiversityTables/NormHists_flat.csv') %>% drop_na()
# Select for only columns that are histograms
norm_hists <- norm_hists_all %>%
  select(contains('Histogram'))
```

**Unsupervised classification histograms**
```{r}
# Read in unsupervised classification histograms
unsup_hists_all <- read_csv('data/DiversityTables/RS_clust_Predictors_new.csv') %>% drop_na()
# Select for only columns that are histograms
unsup_hists <- unsup_hists_all %>%
  select(contains('histogram'))
```

**Tasseled cap histograms**
```{r}
# Get file list for each of the tasseled cap indices
tcb_files <- list.files('data/DiversityTables/', pattern = 'tcb', full.names = TRUE)
tcg_files <- list.files('data/DiversityTables/', pattern = 'tcg', full.names = TRUE)
tcw_files <- list.files('data/DiversityTables/', pattern = 'tcw', full.names = TRUE)

# Function to import and rbind the dataframes
Import_TC <- function(tc_list){
  tc_df = tibble()
  for(i in tc_list){
      indv_tc_df <- read.csv(i, na=c("","NA")) %>% select(c(PrimaryKey, contains('Histogram')))
      tc_df <- rbind(tc_df, indv_tc_df) }
  return(tc_df) }

#Apply the function and then join the dataframes by the Primary key
tcb_df <- Import_TC(tcb_files)
tcg_df <- Import_TC(tcg_files)
tcw_df <- Import_TC(tcw_files)
tc_hists_all <- join_all(list(tcb_df, tcg_df, tcw_df), by = 'PrimaryKey', type = 'left') %>% drop_na()
tc_hists <- tc_hists %>% select(-PrimaryKey)
remove(tcb_files,tcg_files,tcw_files,tcg_df,tcb_df,tcw_df,Import_TC)
```

**Indices' standard deviations and coefficients of variation**
```{r}
# Read in standard deviatons and coefficients of variation tables
sd_cv_all <- read_csv('data/GEEZonalCSVs/RS_Predictors.csv') %>% drop_na()
# Clean df, mutate coefficient of variation columns, reorganize dataframe
sd_cv_div <- sd_cv_all  %>%
  dplyr::select(-c(.geo, VisitYear)) %>%
  drop_na() %>%
  mutate(B1_cv = B1_sd/B1_mn) %>% # Mutate coefficent of variation columns
  mutate(B2_cv = B2_sd/B2_mn) %>%
  mutate(B3_cv = B3_sd/B3_mn) %>%
  mutate(B4_cv = B4_sd/B4_mn) %>%
  mutate(B5_cv = B5_sd/B5_mn) %>%
  mutate(B7_cv = B7_sd/B7_mn) %>%
  mutate(MSAVI2_cv = MSAVI2_sd/MSAVI2_mn) %>%
  mutate(SAVI_cv = SAVI_sd/SAVI_mn) %>%
  mutate(SATVI_cv = SATVI_sd/SATVI_mn) %>%
  mutate(NBR_cv = NBR_sd/NBR_mn) %>%
  mutate(NDMI_cv = NDMI_sd/NDMI_mn) %>%
  mutate(NDVI_cv = NDVI_sd/NDVI_mn) %>%
  mutate(TCA_cv = TCA_sd/TCA_mn) %>%
  mutate(TCG_cv = TCG_sd/TCB_mn) %>%
  mutate(TCW_cv = TCW_sd/TCW_mn) %>%
  mutate(TCB_cv = TCB_sd/TCB_mn) %>%
  select(c(PrimaryKey,contains('_sd'), contains('_cv')))
remove(sd_cv_all)
```

### Calculate spectral diversity
- Counts of class richness
- Shannon diversity index

```{r}
# ---------------------------------------------------------------
####################### INDICES FUNCTION ########################

# Function for calculating spectral richness and Shannon's H; in_PK is a df with a "PrimaryKey" column
Index_CalcDiversity <- function(in_hists, in_PK){
  
    # New tibble with primary keys for later joining
    all_hist_df = as_tibble(in_PK$PrimaryKey)

    # Outer for loop for each histogram column in the in_hists dataframe
    for(i in 1:ncol(in_hists)){
        col_name <- str_sub(colnames(in_hists)[i], end = -10)
        print(col_name)
        
        #New tibble for accumulating richness and shannon's H rows
        hist_df <- tibble()
        
          for(j in 1:nrow(in_hists)){
                # Process character string into simple histograms
                norm <- as.character(in_hists[j,i])
                hist_melt <- strsplit(norm, ',')
                hist_tbl <- as_tibble(matrix(unlist(hist_melt), nrow = (length(hist_melt[[1]])) / 2, byrow=T))
                count_clean <- as_tibble(sub("\\]", "", hist_tbl$V2))
                count_clean <- as_tibble(as.numeric(sub("\\]", "", count_clean$value)))
                count_distinct <- filter(count_clean, value != 0)
                count_list <- unlist(count_distinct)
                count_list <- unname(count_list)
    
                # Derive richness and shannons from histograms
                Rich <- as.numeric(length(count_list))
                ShanH <- diversity(count_list)
    
                div_df <- cbind(Rich, ShanH)
    
                hist_df <- rbind(hist_df, div_df) }
        
        # Prefix columns by classifcation
        hist_df <- hist_df %>%
                    setNames(paste0(col_name, names(.)))
        
        # Bind columns into complete dataframe
        all_hist_df = cbind(all_hist_df, hist_df) }  
    return(all_hist_df)}


# ---------------------------------------------------------------
############# UNSUPERVISED CLASSIFICATION FUNCTION ##############

# Function for calculating spectral richness and Shannon's H; in_PK is a df with a "PrimaryKey" column
Unsup_CalcDiversity <- function(in_hists, in_PK){
  
    # New tibble with primary keys for later joining
    all_hist_df = as_tibble(in_PK$PrimaryKey)

    # Outer for loop for each histogram column in the in_hists dataframe
    for(i in 1:ncol(in_hists)){
        col_name <- str_sub(colnames(in_hists)[i], end = -10)
        print(col_name)
        
        #New tibble for accumulating richness and shannon's H rows
        hist_df <- tibble()
        
          for(j in 1:nrow(in_hists)){
  
                # Process character string into simple histograms
                norm <- as.character(unsup_hists[j,i])
                hist_melt <- strsplit(norm, ',')
                hist_tbl <- as_tibble(matrix(unlist(hist_melt), nrow = (length(hist_melt[[1]])), byrow=T))
                count_clean <- as_tibble(sub("\\}", "", hist_tbl$V1))
                count_clean <- as_tibble(sub("\\{", "", count_clean$value))
                for(k in 1:nrow(count_clean)){
                  val <- count_clean[k,1]
                  count_clean$clean[k] = gsub(".*=","",val)
                  }
                count_list <- unlist(count_clean %>% select(clean))
                count_list <- as.numeric(unname(count_list))
    
                # Derive richness and shannons from histograms
                Rich <- as.numeric(length(count_list))
                ShanH <- diversity(count_list)
    
                div_df <- cbind(Rich, ShanH)
    
                hist_df <- rbind(hist_df, div_df) }
        
        # Prefix columns by classifcation
        hist_df <- hist_df %>%
                    setNames(paste0(col_name, names(.)))
        
        # Bind columns into complete dataframe
        all_hist_df = cbind(all_hist_df, hist_df) }  
    return(all_hist_df)}
```

**Apply functions and reset name for primary key column for joining**
```{r}
# Calculate diversity for each index dataframes
norm_div <- Index_CalcDiversity(in_hists = norm_hists, in_PK = norm_hists_all)
norm_div <- dplyr::rename(norm_div, PrimaryKey = value)

tc_div <- Index_CalcDiversity(in_hists = tc_hists, in_PK = tc_hists_all)
tc_div <- dplyr::rename(tc_div, PrimaryKey = value)

# Calculate diversity for unsupervised classification dataframes
unsup_div <- Unsup_CalcDiversity(in_hists = unsup_hists, in_PK = unsup_hists_all)
unsup_div <- dplyr::rename(unsup_div, PrimaryKey = value)

remove(norm_hists,norm_hists_all,tc_hists,tc_hists_all, unsup_hists,unsup_hists_all,UnSup_CalcDiversity, Index_CalcDiversity)
```

**Import species diversity table**
```{r}
spec_div <- read_csv('data/CSVs/ResponseVariables.csv') %>%
  select(c(PrimaryKey,SpecRich))
```

**Join dataframes for visualization and analysis**
```{r}
# Join spectral predictors--this can be more efficient if needed
spectral_div <- join_all(list(tc_div,norm_div,sd_cv_div,unsup_div), by = 'PrimaryKey', type = 'left')

# Join species diversity to spectral diversity; drop nas, drop PrimaryKey column
all_div <- left_join(spec_div, spectral_div, by = 'PrimaryKey') %>%
                drop_na() %>%
                select(-PrimaryKey)
remove(sd_cv_div,norm_div,tc_div,unsup_div)
```

### Visualize the data
```{r}
corrs = cor(all_div, method = 'pearson', use = 'pairwise.complete.obs')[1,-1]

spectral_div_names = spectral_div %>%
  select(-PrimaryKey) %>%
  colnames()

corrs_df <- as_tibble(cbind(spectral_div_names, as.numeric(corrs)))

ggplot()+
  geom_point(corrs_df, mapping = aes(x = spectral_div_names, y = corrs)) +
  scale_y_continuous(breaks =  seq(-.2, .3, by = .1), limits = c(-.2,.3)) +
  labs(x = 'Spectral diversity measure', y = "Pearson correlations") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90))
```

### Plot top performing spectral diversity index
```{r}
# Plot NDVI 40 bins shannons H
ggplot() +
  geom_point(all_div, mapping = aes(x = SpecRich, y = NDVI_40ShanH), color = 'blue', fill = 'dodgerblue', alpha = .2, shape = 16) + 
  labs(x = 'Species Richness', y = 'Shannons H with 40 bins for NDVI') +
  theme_minimal()
```


